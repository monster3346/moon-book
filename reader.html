<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="pageTitle">Đang tải...</title>
  <meta name="description" content="Đọc chương truyện online miễn phí, giao diện mượt, dark mode hoàn hảo." />
  <meta property="og:title" content="Đọc truyện online" />
  <meta property="og:description" content="Đọc chương truyện online miễn phí, giao diện mượt, dark mode hoàn hảo." />
  <meta property="og:image" content="https://via.placeholder.com/1200x630/4c6ef5/ffffff?text=Moon+Book" />
  <link rel="canonical" href="https://moonbook.vn/reader.html" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4c6ef5">

  <style>
    :root {
      --bg: #f9fbfd;
      --surface: #ffffff;
      --text-primary: #1a202c;
      --text-secondary: #718096;
      --primary: #4c6ef5;
      --primary-light: #748ffc;
      --accent: #38b2ac;
      --border: #e2e8f0;
      --shadow: 0 8px 24px rgba(76, 110, 245, 0.1);
      --radius: 22px;
      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      --font-size: 1.1rem;
      --line-height: 1.9;
      --font-family: 'Roboto', sans-serif;
    }

    [data-theme="dark"] {
      --bg: #0a1221;
      --surface: #1a2332;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --primary: #748ffc;
      --primary-light: #91a7ff;
      --accent: #5eead4;
      --border: #2d3748;
      --shadow: 0 8px 24px rgba(116, 143, 252, 0.2);
    }

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: var(--font-family);
      background: var(--bg);
      color: var(--text-primary);
      line-height: var(--line-height);
      transition: var(--transition);
      overflow-x: hidden;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      background: var(--surface);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
    }

    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      height: 70px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
      font-size: 1rem;
      transition: var(--transition);
    }

    .back-btn:hover {
      color: var(--primary-light);
    }

    .chapter-title {
      font-size: 1.2rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 50%;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .control-btn {
      background: none;
      border: none;
      font-size: 1.4rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: var(--transition);
    }

    .control-btn:hover {
      background: rgba(76, 110, 245, 0.15);
      color: var(--primary);
    }

    .reader-content {
      padding: 40px 0;
      max-width: 800px;
      margin: 0 auto;
      font-size: var(--font-size);
      line-height: var(--line-height);
    }

    .reader-content p {
      margin-bottom: 1.6em;
      text-align: justify;
    }

    .comic-image {
      width: 100%;
      max-width: 100%;
      height: auto;
      display: block;
      margin-bottom: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: var(--surface);
    }

    [data-theme="dark"] .comic-image {
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .chapter-nav {
      display: flex;
      justify-content: space-between;
      margin: 40px 0;
      padding: 20px 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    .nav-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      min-width: 140px;
      justify-content: center;
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      color: var(--text-secondary);
    }

    .nav-btn:not(:disabled):hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .settings-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 16px 0;
      transform: translateY(100%);
      transition: var(--transition);
      z-index: 999;
      box-shadow: 0 -8px 24px rgba(0,0,0,0.1);
    }

    .settings-panel.active {
      transform: translateY(0);
    }

    .settings-inner {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .setting-group {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.95rem;
    }

    .font-size-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .font-size-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: var(--primary);
      width: 0%;
      z-index: 1001;
      transition: width 0.1s ease;
    }

    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: white;
      padding: 16px 36px;
      border-radius: 20px;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.45s ease;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      bottom: 80px;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .loading i {
      margin-right: 12px;
    }

    @media (max-width: 768px) {
      .reader-content {
        padding: 20px 0;
        font-size: 1.05rem;
      }
      .chapter-title {
        display: none;
      }
      .controls {
        gap: 8px;
      }
      .settings-inner {
        gap: 12px;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

  <div class="progress-bar" id="progressBar"></div>

  <header>
    <div class="container header-inner">
      <a href="javascript:history.back()" class="back-btn">
        <i class="fas fa-arrow-left"></i> Quay lại
      </a>
      <div class="chapter-title" id="chapterTitle">Đang tải...</div>
      <div class="controls">
        <button class="control-btn" onclick="openComments()">
          <i class="fas fa-comments"></i>
        </button>
        <button class="control-btn" onclick="toggleSettings()">
          <i class="fas fa-cog"></i>
        </button>
        <button class="control-btn" onclick="toggleTheme()">
          <i class="fas fa-sun" id="themeIcon"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <article class="reader-content" id="chapterContent">
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Đang tải chương...
      </div>
    </article>

    <div class="chapter-nav">
      <button class="nav-btn" id="prevBtn" onclick="prevChapter()" disabled>
        <i class="fas fa-chevron-left"></i> Chương trước
      </button>
      <button class="nav-btn" id="nextBtn" onclick="nextChapter()" disabled>
        Chương tiếp <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </main>

  <div class="settings-panel" id="settingsPanel">
    <div class="container settings-inner">
      <div class="setting-group">
        <span>Font:</span> 
        <button class="font-size-btn active" data-size="1">A</button>
        <button class="font-size-btn" data-size="1.1">A</button>
        <button class="font-size-btn" data-size="1.2">A</button>
      </div>
      <div class="setting-group">
        <span>Khoảng cách dòng:</span>
        <button class="font-size-btn active" data-line="1.8">1.8</button>
        <button class="font-size-btn" data-line="2">2.0</button>
        <button class="font-size-btn" data-line="2.2">2.2</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ==================== API CONFIGURATION ====================
    const API_BASE = 'https://truyen-cute-api.onrender.com';

    async function fetchAPIData(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          method: options.method || 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          body: options.body ? JSON.stringify(options.body) : undefined
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        return { status: 'success', data };

      } catch (error) {
        console.error('API Error:', error);
        return { status: 'error', message: error.message };
      }
    }

    async function fetchStory(slug) {
      return await fetchAPIData(`/api/stories/${slug}`);
    }

    async function fetchChapter(slug, chapNum) {
      return await fetchAPIData(`/api/chapters/${slug}/${chapNum}`);
    }
    // ====================================================================================

    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('slug') || 'demo-truyen';
    const chapterNum = parseInt(urlParams.get('chap')) || 1;

    let storyData = null;
    let currentChapter = null;
    let chaptersList = [];
    let isLoading = false;

    document.addEventListener('DOMContentLoaded', async () => {
      initTheme();
      updateThemeIcon();
      await loadStoryData();
      setupEventListeners();
      loadReaderSettings();
      restoreReadingPosition();
    });

    async function loadStoryData() {
      if (isLoading) return;
      isLoading = true;
      showLoadingState();

      try {
        const storyResult = await fetchStory(slug);
        if (storyResult.status === 'error') throw new Error(storyResult.message || 'Không thể tải thông tin truyện');

        storyData = {
          slug: slug,
          title: storyResult.data.title || 'Không tên',
          chapters: (storyResult.data.chapters || []).map(ch => ({
            num: ch.num || 1,
            title: ch.title || 'Không tên',
            content: ch.content || null,
            images: ch.images || null
          }))
        };

        storyData.chapters.sort((a, b) => a.num - b.num);
        chaptersList = storyData.chapters;
        await loadCurrentChapter();

      } catch (error) {
        console.error('Lỗi tải dữ liệu truyện:', error);
        const savedStory = localStorage.getItem(`story_${slug}`);
        if (savedStory) {
          storyData = JSON.parse(savedStory);
          chaptersList = storyData.chapters;
          await loadCurrentChapter();
          showToast('Đang hiển thị dữ liệu tạm thời');
        } else {
          useSampleData();
        }
      } finally {
        isLoading = false;
      }
    }

    async function loadCurrentChapter() {
      try {
        const chapterResult = await fetchChapter(slug, chapterNum);
        if (chapterResult.status === 'success' && chapterResult.data) {
          currentChapter = {
            num: chapterResult.data.num || chapterNum,
            title: chapterResult.data.title || `Chương ${chapterNum}`,
            content: chapterResult.data.content || null,
            images: chapterResult.data.images || null
          };
        } else {
          currentChapter = chaptersList.find(c => c.num === chapterNum) || chaptersList[0];
        }
        renderChapter();
      } catch (error) {
        console.log('Không thể tải nội dung chương riêng, dùng danh sách chương');
        currentChapter = chaptersList.find(c => c.num === chapterNum) || chaptersList[0];
        renderChapter();
      }
    }

    function useSampleData() {
      storyData = {
        slug: slug,
        title: "Solo Leveling",
        chapters: [
          { num: 1, title: "Thức tỉnh", content: "Trong một thế giới mà các cổng kết nối với dungeon xuất hiện...\n\nSung Jin-Woo, hunter hạng E yếu nhất, bước vào raid nguy hiểm...\n\nKhông ai ngờ rằng, khoảnh khắc cận tử chính là lúc hệ thống bí ẩn kích hoạt...\n\n“Chào mừng đến với Hệ thống Cấp Độ.”", images: null },
          { num: 2, title: "Hệ thống", content: "Hệ thống cho anh ta nhiệm vụ hàng ngày...\n\nPush-up 100 lần? Squat 100 lần?\n\nJin-Woo cười nhạt: “Đây là trò đùa à?”", images: null },
          { num: 3, title: "Raid đầu tiên", content: null, images: ["https://via.placeholder.com/800x1200/4c6ef5/ffffff?text=Trang+1", "https://via.placeholder.com/800x1200/38b2ac/ffffff?text=Trang+2"] }
        ]
      };
      chaptersList = storyData.chapters;
      currentChapter = chaptersList.find(c => c.num === chapterNum) || chaptersList[0];
      renderChapter();
      showToast('Đang dùng dữ liệu mẫu');
    }

    function showLoadingState() {
      document.getElementById('chapterContent').innerHTML = `
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i> Đang tải chương...
        </div>
      `;
      document.getElementById('prevBtn').disabled = true;
      document.getElementById('nextBtn').disabled = true;
    }

    function renderChapter() {
      if (!currentChapter) return;

      document.title = `Chương ${currentChapter.num}: ${currentChapter.title} - ${storyData.title}`;
      document.getElementById('chapterTitle').textContent = `Chương ${currentChapter.num}: ${currentChapter.title}`;

      if (currentChapter.content) {
        const formattedContent = currentChapter.content.replace(/\n/g, '<br>');
        document.getElementById('chapterContent').innerHTML = `<p>${formattedContent}</p>`;
      } else if (currentChapter.images && currentChapter.images.length > 0) {
        const imagesHtml = currentChapter.images.map(img => 
          `<img src="${img}" class="comic-image" loading="lazy" alt="Trang truyện">`
        ).join('');
        document.getElementById('chapterContent').innerHTML = imagesHtml;
      } else {
        document.getElementById('chapterContent').innerHTML = '<p>Nội dung trống</p>';
      }

      document.getElementById('pageTitle').textContent = document.title;

      const currentIndex = chaptersList.findIndex(c => c.num === currentChapter.num);
      document.getElementById('prevBtn').disabled = currentIndex <= 0;
      document.getElementById('nextBtn').disabled = currentIndex >= chaptersList.length - 1;

      localStorage.setItem(`story_${slug}`, JSON.stringify(storyData));
      localStorage.setItem(`currentChapter_${slug}_${chapterNum}`, JSON.stringify(currentChapter));
    }

    function prevChapter() {
      const currentIndex = chaptersList.findIndex(c => c.num === currentChapter.num);
      if (currentIndex > 0) goToChapter(chaptersList[currentIndex - 1].num);
    }

    function nextChapter() {
      const currentIndex = chaptersList.findIndex(c => c.num === currentChapter.num);
      if (currentIndex < chaptersList.length - 1) goToChapter(chaptersList[currentIndex + 1].num);
    }

    function goToChapter(num) {
      window.location.href = `?slug=${slug}&chap=${num}`;
    }

    function setupEventListeners() {
      document.querySelectorAll('[data-size]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-size]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.documentElement.style.setProperty('--font-size', btn.dataset.size + 'rem');
          localStorage.setItem('reader_font_size', btn.dataset.size);
        });
      });

      document.querySelectorAll('[data-line]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-line]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.documentElement.style.setProperty('--line-height', btn.dataset.line);
          localStorage.setItem('reader_line_height', btn.dataset.line);
        });
      });

      document.addEventListener('keydown', e => {
        if (e.key === 'ArrowLeft') prevChapter();
        if (e.key === 'ArrowRight') nextChapter();
        if (e.key === ' ') {
          e.preventDefault();
          window.scrollBy(0, window.innerHeight * 0.8);
        }
        if (e.key === 'c' || e.key === 'C') openComments();
      });

      window.addEventListener('scroll', () => {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = height > 0 ? (winScroll / height) * 100 : 0;
        document.getElementById('progressBar').style.width = scrolled + '%';
      });

      let touchStartX = 0;
      document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      });
      document.addEventListener('touchend', e => {
        const touchEndX = e.changedTouches[0].screenX;
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) nextChapter();
          else prevChapter();
        }
      });
    }

    function loadReaderSettings() {
      const savedFont = localStorage.getItem('reader_font_size') || '1.1';
      const savedLine = localStorage.getItem('reader_line_height') || '1.9';
      document.documentElement.style.setProperty('--font-size', savedFont + 'rem');
      document.documentElement.style.setProperty('--line-height', savedLine);
      document.querySelector(`[data-size="${savedFont}"]`)?.classList.add('active');
      document.querySelector(`[data-line="${savedLine}"]`)?.classList.add('active');
    }

    function toggleSettings() {
      document.getElementById('settingsPanel').classList.toggle('active');
    }

    function initTheme() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme === 'dark' ? 'dark' : '');
      updateThemeIcon();
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon();
    }

    function updateThemeIcon() {
      const icon = document.getElementById('themeIcon');
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
    }

    function openComments() {
      window.location.href = `comments.html?slug=${slug}&chap=${currentChapter.num}`;
    }

    function saveReadingProgress() {
      const progress = {
        slug,
        chapter: currentChapter.num,
        scroll: window.scrollY,
        timestamp: Date.now()
      };
      localStorage.setItem(`progress_${slug}`, JSON.stringify(progress));
      showToast('Đã lưu vị trí đọc!');
    }

    function restoreReadingPosition() {
      const saved = localStorage.getItem(`progress_${slug}`);
      if (saved) {
        const progress = JSON.parse(saved);
        if (progress.chapter === currentChapter.num) {
          setTimeout(() => window.scrollTo(0, progress.scroll), 100);
        }
      }
    }

    setInterval(saveReadingProgress, 10000);
    window.addEventListener('beforeunload', saveReadingProgress);

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
  </script>
</body>
</html>